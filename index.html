<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>University Map with Live Location (Backend-ready)</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #ff7b25;
      --secondary-color: #e64a19;
      --accent-color: #ff9800;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
      --transition: all 0.3s ease;
    }
    [data-theme="dark"] {
      --primary-color: #ff9800;
      --secondary-color: #ff7b25;
      --accent-color: #e64a19;
      --light-color: #212529;
      --dark-color: #f8f9fa;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Poppins', sans-serif; color: var(--dark-color); background-color: var(--light-color); transition: background-color 0.3s ease, color 0.3s ease; }
    #map { width: 100%; height: 100vh; }
    #controls { position: absolute; top: 20px; left: 20px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: var(--border-radius); width: 280px; box-shadow: var(--shadow); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); }
    [data-theme="dark"] #controls { background: rgba(40,40,40,0.9); color: #fff; border: 1px solid rgba(0,0,0,0.3); }
    #controls label { display:block; margin:8px 0 4px; font-weight:500; color:var(--dark-color); font-size:14px; }
    #controls select, #controls button, #controls input { margin:6px 0; width:100%; padding:10px; border:1px solid #ddd; border-radius:var(--border-radius); font-family:'Poppins'; font-size:14px; transition:var(--transition); background-color:white; }
    #controls button { background-color:var(--primary-color); color:#fff; border:none; cursor:pointer; font-weight:500; margin-top:10px; }
    #indoorControls { position:absolute; top:20px; right:20px; z-index:1000; background: rgba(255,255,255,0.95); padding:15px; border-radius:var(--border-radius); width:320px; box-shadow:var(--shadow); backdrop-filter: blur(5px); border:1px solid rgba(255,255,255,0.3); }
    .tab { overflow:hidden; border:1px solid #ddd; background-color:#f1f1f1; border-radius: var(--border-radius) var(--border-radius) 0 0; display:flex; }
    .tab button { background:inherit; border:none; outline:none; cursor:pointer; padding:10px 12px; transition:var(--transition); flex:1; text-align:center; font-size:12px; }
    .tab button:hover { background:#ddd; }
    .tab button.active { background:var(--primary-color); color:white; }
    .tabcontent { display:none; padding:15px; border:1px solid #ddd; border-top:none; border-radius: 0 0 var(--border-radius) var(--border-radius); background:white; }
    .floor-plan { width:100%; height:auto; margin:10px 0; border:1px solid #ddd; border-radius:var(--border-radius); cursor:pointer; transition:var(--transition); }
    .room-info { margin-top:15px; padding:12px; background:#f8f9fa; border-radius:var(--border-radius); border-left:4px solid var(--primary-color); }
    #zoomOverlay { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center; cursor:zoom-out; }
    #zoomedImage { max-width:90vw; max-height:90vh; border:5px solid white; border-radius:10px; box-shadow:0 10px 25px rgba(0,0,0,0.5); }
    .marker { background-image: url('https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png'); background-size:cover; width:30px; height:40px; cursor:pointer; }
    .event-marker { background-color:#f72585; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px rgba(247,37,133,0.5); display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; font-size:10px; }
    .favorite-marker { background-color:var(--accent-color); width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px rgba(255,152,0,0.5); display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; font-size:10px; }
    .theme-toggle { position:absolute; top:20px; right:20px; z-index:1000; background: rgba(255,255,255,0.9); border:none; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow); backdrop-filter: blur(5px); border:1px solid rgba(255,255,255,0.3); }
    /* Settings Panel */
    #settingsPanel { position: absolute; top: 20px; right: 360px; background: rgba(255,255,255,0.97); padding: 14px; border-radius: 10px; width: 320px; z-index: 2100; box-shadow: var(--shadow); display: none; border:1px solid rgba(255,255,255,0.6); }
    #settingsPanel input, #settingsPanel textarea, #settingsPanel select, #settingsPanel button { width: 100%; margin-top: 8px; padding: 8px; border-radius: 6px; }
    #settingsToggleBtn { position:absolute; top:70px; right:20px; z-index:2000; background: rgba(255,255,255,0.95); border:none; border-radius:50%; width:44px; height:44px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow); }
    .spinner { display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:white; animation:spin 1s ease-in-out infinite; margin-right:8px; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* responsive */
    @media (max-width: 768px) {
      #controls, #indoorControls, #eventsControls { width: 90%; left: 5%; right:5%; top: 10px; }
      #indoorControls, #eventsControls { top: auto; bottom: 20px; }
    }
  </style>
</head>
<body>

<div id="controls">
  <h3 style="margin-bottom: 10px; color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 8px;">Campus Navigation</h3>
  
  <label for="location">Go to Location:</label>
  <select id="location" onchange="goToLocation()"></select>

  <div style="margin: 15px 0; border-top: 1px solid #eee; padding-top: 10px;">
    <label for="start">Start Point:</label>
    <select id="start"></select>

    <label for="destination">Destination:</label>
    <select id="destination"></select>

    <button onclick="updateRoute()">
      <span id="routeSpinner" class="spinner" style="display: none;"></span>
      Show Route
    </button>
    <button onclick="useLiveLocation()">
      <span id="locationSpinner" class="spinner" style="display: none;"></span>
      Use Live Location
    </button>
    <button id="stopLiveLocation" style="display:none;" onclick="stopLiveLocationTracking()">Stop Live Tracking</button>
  </div>
  
  <button onclick="toggleEventsPanel()" style="margin-top: 10px;">Show Events</button>
  <button onclick="toggleFavoritesPanel()" style="margin-top: 10px;">My Favorites</button>
</div>

<div id="indoorControls">
  <h3 style="margin-bottom: 10px; color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 8px;">Indoor Navigation</h3>
  
  <select id="buildingSelector" onchange="showBuildingFloors()">
    <option value="">Select Building</option>
    <option value="1">Building 1</option>
    <option value="2">Building 2</option>
    <option value="3">Building 3</option>
    <option value="4">Building 4</option>
    <option value="5">Building 5</option>
    <option value="6">Building 6</option>
    <option value="7">Building 7</option>
  </select>

  <div id="building2Controls" style="display:none;">
    <div class="tab">
      <button class="tablinks active" onclick="openFloor(event, 'groundFloor')">Ground Floor</button>
      <button class="tablinks" onclick="openFloor(event, 'firstFloor')">1st Floor</button>
      <button class="tablinks" onclick="openFloor(event, 'secondFloor')">2nd Floor</button>
      <button class="tablinks" onclick="openFloor(event, 'thirdFloor')">3rd Floor</button>
      <button class="tablinks" onclick="openFloor(event, 'fourthFloor')">4th Floor</button>
    </div>

    <div id="groundFloor" class="tabcontent" style="display:block;">
      <img src="https://via.placeholder.com/400x300?text=Building+2+Ground+Floor" alt="Ground Floor" class="floor-plan" onclick="zoomImage(this.src)">
      <select id="groundFloorRooms" onchange="showRoomInfo('ground')">
        <option value="">Select a room</option>
      </select>
      <div id="groundFloorInfo" class="room-info"></div>
    </div>

    <div id="firstFloor" class="tabcontent">
      <img src="https://via.placeholder.com/400x300?text=Building+2+1st+Floor" alt="1st Floor" class="floor-plan" onclick="zoomImage(this.src)">
      <select id="firstFloorRooms" onchange="showRoomInfo('first')">
        <option value="">Select a room</option>
      </select>
      <div id="firstFloorInfo" class="room-info"></div>
    </div>

    <div id="secondFloor" class="tabcontent">
      <img src="https://via.placeholder.com/400x300?text=Building+2+2nd+Floor" alt="2nd Floor" class="floor-plan" onclick="zoomImage(this.src)">
      <select id="secondFloorRooms" onchange="showRoomInfo('second')">
        <option value="">Select a room</option>
      </select>
      <div id="secondFloorInfo" class="room-info"></div>
    </div>

    <div id="thirdFloor" class="tabcontent">
      <img src="https://via.placeholder.com/400x300?text=Building+2+3rd+Floor" alt="3rd Floor" class="floor-plan" onclick="zoomImage(this.src)">
      <select id="thirdFloorRooms" onchange="showRoomInfo('third')">
        <option value="">Select a room</option>
      </select>
      <div id="thirdFloorInfo" class="room-info"></div>
    </div>

    <div id="fourthFloor" class="tabcontent">
      <img src="https://via.placeholder.com/400x300?text=Building+2+4th+Floor" alt="4th Floor" class="floor-plan" onclick="zoomImage(this.src)">
      <select id="fourthFloorRooms" onchange="showRoomInfo('fourth')">
        <option value="">Select a room</option>
      </select>
      <div id="fourthFloorInfo" class="room-info"></div>
    </div>
  </div>
</div>

<!-- Settings Panel -->
<div id="settingsPanel">
  <h3 style="margin-bottom:8px; color:var(--primary-color)">Settings</h3>

  <label>Building:</label>
  <select id="settingsBuilding">
    <option value="building2">Building 2</option>
  </select>

  <label>Floor:</label>
  <input id="settingsFloor" placeholder="e.g., ground, first, fourth">

  <label>Room ID:</label>
  <input id="settingsRoomId" placeholder="e.g., 2001">

  <label>Room Name:</label>
  <input id="settingsRoomName" placeholder="e.g., Seminar Hall">

  <label>Staff (comma separated):</label>
  <textarea id="settingsStaff" rows="3" placeholder="Staff1, Staff2"></textarea>

  <button onclick="saveRoomSettings()">Save Room</button>

  <hr style="margin:12px 0;">

  <label>New Floor Name:</label>
  <input id="newFloorName" placeholder="e.g., fifth">
  <button onclick="addNewFloor()">Add Floor</button>

  <p style="font-size:12px; color:#666; margin-top:8px;">Note: Save will POST to <code>/api/update-room</code>. Add Floor will POST to <code>/api/add-floor</code>.</p>
</div>

<!-- Settings toggle button -->
<button id="settingsToggleBtn" title="Toggle settings" onclick="toggleSettings()">⚙️</button>

<!-- Events Panel -->
<div id="eventsControls" style="display:none;">
  <h3 style="margin-bottom: 10px; color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 8px;">Upcoming Events</h3>
  <div id="eventsList"></div>
</div>

<!-- Favorites Panel -->
<div id="favoritesPanel" style="display:none;">
  <h3 style="margin-bottom: 10px; color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 8px;">My Favorite Locations</h3>
  <div id="favoritesList"></div>
</div>

<!-- Theme toggle button (floating) -->
<button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">🌓</button>

<div id="map"></div>

<!-- Image Zoom Overlay -->
<div id="zoomOverlay" onclick="closeZoom()">
  <img id="zoomedImage" src="" />
</div>

<script>
  // Mapbox token (kept as in original file)
  mapboxgl.accessToken = 'pk.eyJ1IjoidmVkYW50b20iLCJhIjoiY202bWEweDMwMGV2YzJrczRlZ2JtYWZibSJ9.LC_mF9gyUu5vBXuot8FQWQ';

  // Locations (unchanged) - used for markers & route dropdowns
  const locations = [
    { name: "Building 2", coords: [73.88367516423422, 18.459181351404517], image: "https://via.placeholder.com/150", description: "Engineering Dept" },
    { name: "Main Building", coords: [73.8835843028105, 18.460288315096374], image: "Building_VU_2-min.jpg", description: "Admin", zoomable: true },
    { name: "Building 4", coords: [73.88416703777891, 18.458350387535205], image: "Building_-__Design___Architecture.jpg", description: "architecture", zoomable: true },
    { name: "Building 5", coords: [73.88385830208395, 18.457996621351942], image: "Building_-__Design___Architecture.jpg", description: "library and design classes ", zoomable: true },
    { name: "playground", coords: [73.88390385295752, 18.457775500169415], image: "sports.jpeg", description: "volleyball court", zoomable: true	 },
    { name: "Playground", coords: [73.88390653242094, 18.457495921254193], image: "https://via.placeholder.com/150", description: "Main Ground for Events" },
    { name: "Building 3", coords: [73.88407773451284, 18.45874112469597], image: "https://via.placeholder.com/150", description: "Lecture Halls" },
    { name: "Canteen", coords: [73.88411692573803, 18.458480900120453], image: "https://via.placeholder.com/150", description: "Food & Beverages" }
  ];

  // Fallback initial building2Rooms data (used if backend not running)
  const initialBuilding2Rooms = {
    ground: {
      "2001": { name: "Seminar Hall", staff: [] },
      "2002": { name: "Staff room (central store)", staff: [] },
      "2003A": { name: "Placement office", staff: ["Trupti Shinde", "Swati Shriyal", "Kavita Kumavat"] },
      "2003B": { name: "Stationery Store & Reprography", staff: ["Tareek Pattewar", "Maya mam", "Jgdish tawade"] },
      "2003C": { name: "First Aid Cum Sick Room", staff: ["Noshir Tarapore"] },
      "2004": { name: "Mechanical Staff Room", staff: [] },
      "2005-2006": { name: "Computer Center, Language Lab, Laboratory", staff: [] },
      "2007": { name: "Boys Washroom", staff: [] },
      "2008": { name: "Staff Room", staff: [
        "Suhas chavan", "Gulnaz thakur", "Maghanand bhambre", "Divya munot", 
        "Richa panchgaur", "Bhagyalaxmi mam", "Prachati mam", "Yogita patil", 
        "Purva thakur", "Pooman adhakari", "Shreedevi hiremat", "Mahfooz alam", 
        "Sukhpreet kour", "Palavi morey"
      ]},
      "2009": { name: "Computer Lab", staff: ["Arti patle sardhara", "Prajakta dhamdhare", "mahadewi saxena"] },
      "2010": { name: "Computer Lab", staff: ["Pavitha nooji", "Kanchan katake", "Seema vanjire"] },
      "2011": { name: "Computer Lab", staff: ["Vivek thorat", "Ajit mane", "Sagar mahajan"] },
      "2012": { name: "Computer Lab", staff: ["Sital Dash", "Vaishali Babu", "Sumaira Shaikh"] },
      "2013-2014": { name: "Laboratory", staff: [] },
      "2015": { name: "Girls washroom", staff: [] }
    },
    first: {
      "2101": { name: "SAPS lab", staff: [] },
      "2102a": { name: "Faculty Room", staff: [
        "Prajakta Kapadnis", "kirti Deshpande", "Mrunalini Kulkarni", 
        "Lida Sajimon", "Archana Shaha", "Yogita Shinde"
      ]},
      "2102b": { name: "Seminar Hall PH", staff: [] },
      "2103": { name: "Classroom (Pharmacy)", staff: [] },
      "2104a": { name: "Faculty Room", staff: [
        "Poonam Taru", "Dr Dipali Talele", "Bhavna Mahajan", "Dr Priyanka Karpe"
      ]},
      "2104b": { name: "Pharmacognosy Laboratory-1", staff: [] },
      "2105": { name: "HAP/Pharmacology Laboratory 1", staff: [] },
      "2106": { name: "Pharmaceutics Laboratory 1", staff: [] },
      "2107": { name: "Pharmaceutics Laboratory 2", staff: [] },
      "2108a": { name: "Faculty Room", staff: [
        "Madhav Shelke", "Sonali Manwatkar", "Swati Mutha"
      ]},
      "2108b": { name: "Pharmaceutics Laboratory 3", staff: [] },
      "2109": { name: "Gents Toilet", staff: [] },
      "2110": { name: "FE lab", staff: [] },
      "2111": { name: "Classroom", staff: [] },
      "2112": { name: "Classroom", staff: [] },
      "2113": { name: "Classroom", staff: [] },
      "2114": { name: "Classroom", staff: [] },
      "2115": { name: "Classroom", staff: [] },
      "2116": { name: "Cabin of HOD/Departments Office", staff: [
        "Prof. Aditya Bhope", "Mr. Srinivas Chippalkatti", 
        "Dr. Sandhya Tapadia", "Dr. Jupindar Kaur", "Jameel Ansari"
      ]},
      "2117": { name: "Ladies Common Room + Ladies Toilet", staff: [] }
    },
    second: {
      // placeholder example rooms (empty initially in original)
    },
    third: {
      "2301": { name: "Pharmacognosy Laboratory- 2", staff: [] },
      "2302": { name: "Pharmacology Laboratory- 2", staff: [] },
      "2303": { name: "Classroom", staff: [] },
      "2304": { name: "Classroom", staff: [] },
      "2305": { name: "Classroom", staff: [] },
      "2306": { name: "Classroom", staff: [] },
      "2307": { name: "Pharmaceutics Lab", staff: [] },
      "2308": { name: "Pharmaceuticals Chemistry Laboratory- 2", staff: [] },
      "2309": { name: "Pharmacy Practice Lab", staff: [] },
      "2310": { name: "Gents Toilet", staff: [] },
      "2311": { name: "Classroom", staff: [] },
      "2312": { name: "Classroom", staff: [] },
      "2313": { name: "Dean's Office", staff: [] },
      "2314": { name: "Computer Centre and Languages Lab", staff: [] },
      "2315": { name: "Store room - 2 (Glassware & Equipments)", staff: [] },
      "2316": { name: "Store room - 1A (Chemicals)", staff: [] },
      "2317": { name: "Faculty Room", staff: [
        "Dr. Om Bagade", "Dr. Nitesh Bhatia", "Dr. Amrita Thakur", 
        "Dr. Neeta Rai", "Dr. Sabeena Syed", "Prof. Supriya Unavane", 
        "Prof. Snehal Hase"
      ]}
    },
    fourth: {
      // new 4th floor added (empty by default)
    }
  };

  // building2Rooms will be loaded from backend if available, otherwise fallback to initialBuilding2Rooms
  let building2Rooms = {};

  // Sample events data (unchanged)
  const events = [
    { id: 1, title: "Career Fair 2023", description: "Annual university career fair with top companies", location: "Main Building", coords: [73.8835843028105, 18.460288315096374], date: "2023-11-15", time: "10:00 AM - 4:00 PM", category: "career" },
    { id: 2, title: "Engineering Seminar", description: "Guest lecture on modern engineering practices", location: "Building 2", coords: [73.88367516423422, 18.459181351404517], date: "2023-11-18", time: "2:00 PM - 4:00 PM", category: "academic" },
    { id: 3, title: "Sports Day", description: "Annual inter-department sports competition", location: "Main Ground", coords: [73.88390653242094, 18.457495921254193], date: "2023-11-22", time: "9:00 AM - 5:00 PM", category: "sports" },
    { id: 4, title: "Art Exhibition", description: "Student art showcase in the design building", location: "Building 5", coords: [73.88385830208395, 18.457996621351942], date: "2023-11-25", time: "11:00 AM - 7:00 PM", category: "arts" }
  ];

  // Favorites storage
  let favorites = JSON.parse(localStorage.getItem('mapFavorites')) || [];
  let favoriteMarkers = [];

  // Map initialization
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: locations[0].coords,
    zoom: 16
  });

  let liveLocationMarker = null;
  let liveLocationWatchId = null;
  let remainingRouteCoordinates = [];
  let currentRouteSource = null;
  let destinationMarker = null;
  let eventMarkers = [];
  let eventsPanelVisible = false;

  map.on('load', () => {
    map.setPitch(60);
    map.setBearing(-17.6);

    const labelLayerId = map.getStyle().layers.find(
      l => l.type === 'symbol' && l.layout['text-field']
    )?.id;

    map.addLayer({
      id: '3d-buildings',
      source: 'composite',
      'source-layer': 'building',
      filter: ['==', 'extrude', 'true'],
      type: 'fill-extrusion',
      minzoom: 15,
      paint: {
        'fill-extrusion-color': '#aaa',
        'fill-extrusion-height': ['get', 'height'],
        'fill-extrusion-base': ['get', 'min_height'],
        'fill-extrusion-opacity': 0.6
      }
    }, labelLayerId);

    addMarkers();
    populateDropdowns();
    loadFavorites();
  });

  // Add map markers from 'locations'
  function addMarkers() {
    locations.forEach(loc => {
      const popupContent = `
        <div style="width: 200px;">
          <h4 style="margin-bottom: 8px; color: var(--primary-color);">${loc.name}</h4>
          <img src="${loc.image}" alt="${loc.name}" 
               style="width: 100%; height: auto; cursor: ${loc.zoomable ? 'zoom-in' : 'default'}; 
                      border-radius: 4px; margin-bottom: 8px;" 
               ${loc.zoomable ? 'onclick="zoomImage(this.src)"' : ''} />
          <p style="font-size: 14px; color: #555;">${loc.description}</p>
          ${getFavoriteButtonHTML(loc.coords, loc.name)}
        </div>
      `;
      let color = '#ff7b25';
      if (loc.name.toLowerCase().includes('building')) color = '#e64a19';
      if (loc.name.toLowerCase().includes('canteen')) color = '#f72585';
      if (loc.name.toLowerCase().includes('playground')) color = '#ff9800';
      
      const el = document.createElement('div');
      el.className = 'marker';
      el.style.backgroundColor = color;
      el.style.width = '20px';
      el.style.height = '20px';
      el.style.borderRadius = '50%';
      el.style.border = '2px solid white';
      el.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
      
      const marker = new mapboxgl.Marker({ element: el })
        .setLngLat(loc.coords)
        .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupContent))
        .addTo(map);
      
      loc.marker = marker;
    });
  }

  function getFavoriteButtonHTML(coords, name) {
    const isFavorite = favorites.some(fav => fav.coords.lng === coords[0] && fav.coords.lat === coords[1]);
    if (isFavorite) {
      return `<button class="remove-favorite-btn-popup" onclick="removeFavoriteByCoords([${coords}], event)">Remove from Favorites</button>`;
    } else {
      return `<button class="add-favorite-btn-popup" onclick="addFavoriteByCoords([${coords}], '${name}', event)">Add to Favorites</button>`;
    }
  }

  function populateDropdowns() {
    const selects = ['location', 'start', 'destination'];
    selects.forEach(id => {
      const select = document.getElementById(id);
      while (select.options.length > 0) select.remove(0);
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = id === 'location' ? "Select a location..." : "Select...";
      select.appendChild(defaultOption);
      locations.forEach(loc => {
        const option = document.createElement("option");
        option.value = `${loc.coords[1]},${loc.coords[0]}`;
        option.textContent = loc.name;
        select.appendChild(option);
      });
    });
  }

  function goToLocation() {
    const value = document.getElementById('location').value;
    if (!value) return;
    const [lat, lng] = value.split(',').map(Number);
    map.flyTo({ center: [lng, lat], zoom: 18 });
  }

  // Route & live location functions (unchanged)
  function updateRoute(startCoord, endCoord) {
    if (!startCoord || !endCoord) {
      const startValue = document.getElementById('start').value;
      const endValue = document.getElementById('destination').value;
      if (!startValue || !endValue) {
        alert('Please select both start and destination points');
        return;
      }
      const [startLat, startLng] = startValue.split(',').map(Number);
      const [endLat, endLng] = endValue.split(',').map(Number);
      startCoord = [startLng, startLat];
      endCoord = [endLng, endLat];
    }

    document.getElementById('routeSpinner').style.display = 'inline-block';
    if (destinationMarker) destinationMarker.remove();

    destinationMarker = new mapboxgl.Marker({ color: "#f44336" })
      .setLngLat(endCoord)
      .setPopup(new mapboxgl.Popup().setText("Destination"))
      .addTo(map);

    fetch(`https://api.mapbox.com/directions/v5/mapbox/walking/${startCoord.join(',')};${endCoord.join(',')}?geometries=geojson&access_token=${mapboxgl.accessToken}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('routeSpinner').style.display = 'none';
        if (map.getSource('route')) {
          map.removeLayer('route'); map.removeLayer('route-arrows'); map.removeSource('route');
        }
        remainingRouteCoordinates = data.routes[0].geometry.coordinates;
        map.addSource('route', { type: 'geojson', data: { type: 'Feature', properties: {}, geometry: data.routes[0].geometry } });
        currentRouteSource = 'route';
        map.addLayer({ id: 'route', type: 'line', source: 'route', layout: {'line-join':'round','line-cap':'round'}, paint: { 'line-color': '#ff7b25','line-width':5,'line-opacity':0.8 } });
        map.addLayer({ id: 'route-arrows', type: 'symbol', source: 'route', layout: { 'symbol-placement': 'line','text-field': '▶','text-size': 12,'symbol-spacing': 50,'text-keep-upright': false }, paint: { 'text-color': '#ffffff','text-halo-color': '#ff7b25','text-halo-width': 1 } });
        map.fitBounds([startCoord, endCoord], { padding: {top:100,bottom:100,left:100,right:100} });
      })
      .catch(error => {
        console.error('Error fetching route:', error);
        document.getElementById('routeSpinner').style.display = 'none';
        alert('Error calculating route. Please try again.');
      });
  }

  function useLiveLocation() {
    if (!navigator.geolocation) { alert('Geolocation is not supported by your browser'); return; }
    const destinationValue = document.getElementById('destination').value;
    if (!destinationValue) { alert('Please select a destination first'); return; }
    document.getElementById('locationSpinner').style.display = 'inline-block';
    document.getElementById('stopLiveLocation').style.display = 'block';
    document.querySelector('#controls button[onclick="useLiveLocation()"]').style.display = 'none';

    navigator.geolocation.getCurrentPosition(position => {
      document.getElementById('locationSpinner').style.display = 'none';
      const liveCoords = [position.coords.longitude, position.coords.latitude];
      const [destLat, destLng] = destinationValue.split(',').map(Number);
      const destinationCoords = [destLng, destLat];
      if (!liveLocationMarker) {
        const el = document.createElement('div');
        el.className = 'live-location-marker';
        el.style.backgroundColor = '#ff9800';
        el.style.width = '20px';
        el.style.height = '20px';
        el.style.borderRadius = '50%';
        el.style.border = '2px solid white';
        el.style.boxShadow = '0 0 10px rgba(255, 152, 0, 0.7)';
        liveLocationMarker = new mapboxgl.Marker({ element: el }).setLngLat(liveCoords).setPopup(new mapboxgl.Popup().setText("You are here")).addTo(map);
      } else {
        liveLocationMarker.setLngLat(liveCoords);
      }

      if (destinationMarker) destinationMarker.remove();
      destinationMarker = new mapboxgl.Marker({ color: "#f44336" }).setLngLat(destinationCoords).setPopup(new mapboxgl.Popup().setText("Destination")).addTo(map);
      map.flyTo({ center: liveCoords, zoom: 17 });
      updateRoute(liveCoords, destinationCoords);

      liveLocationWatchId = navigator.geolocation.watchPosition(
        position => updateLivePosition(position, destinationCoords),
        error => { console.error('Error getting live location:', error); document.getElementById('locationSpinner').style.display = 'none'; },
        { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
      );

    }, (error) => {
      console.error('Error getting location:', error);
      document.getElementById('locationSpinner').style.display = 'none';
      alert('Unable to retrieve your location');
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
  }

  function stopLiveLocationTracking() {
    if (liveLocationWatchId) { navigator.geolocation.clearWatch(liveLocationWatchId); liveLocationWatchId = null; }
    if (liveLocationMarker) { liveLocationMarker.remove(); liveLocationMarker = null; }
    if (destinationMarker) { destinationMarker.remove(); destinationMarker = null; }
    if (map.getSource('route')) { try { map.removeLayer('route'); map.removeLayer('route-arrows'); map.removeSource('route'); } catch(e){} }
    document.querySelector('#controls button[onclick="useLiveLocation()"]').style.display = 'block';
    document.getElementById('stopLiveLocation').style.display = 'none';
  }

  function updateLivePosition(position, destinationCoords) {
    const liveCoords = [position.coords.longitude, position.coords.latitude];
    if (liveLocationMarker) liveLocationMarker.setLngLat(liveCoords);
    map.flyTo({ center: liveCoords, zoom: 17 });

    if (remainingRouteCoordinates && remainingRouteCoordinates.length > 0) {
      let closestPointIndex = 0; let minDistance = Infinity;
      remainingRouteCoordinates.forEach((coord, index) => {
        const distance = getDistance(liveCoords, coord);
        if (distance < minDistance) { minDistance = distance; closestPointIndex = index; }
      });
      if (minDistance < 0.0001) {
        remainingRouteCoordinates = remainingRouteCoordinates.slice(closestPointIndex);
        updateRemainingRoute(remainingRouteCoordinates);
      }
    }
  }

  function updateRemainingRoute(coordinates) {
    if (coordinates.length < 2) return;
    const geojson = { type: 'Feature', geometry: { type: 'LineString', coordinates: coordinates } };
    if (map.getSource(currentRouteSource)) {
      map.getSource(currentRouteSource).setData(geojson);
    } else {
      map.addSource(currentRouteSource, { type: 'geojson', data: geojson });
      map.addLayer({ id: currentRouteSource, type: 'line', source: currentRouteSource, layout: { 'line-join': 'round','line-cap':'round' }, paint: { 'line-color': '#ff7b25','line-width':5,'line-opacity':0.8 } });
    }
  }

  function getDistance(coord1, coord2) {
    const dx = coord1[0] - coord2[0];
    const dy = coord1[1] - coord2[1];
    return Math.sqrt(dx * dx + dy * dy);
  }

  function zoomImage(src) {
    const overlay = document.getElementById('zoomOverlay');
    const zoomedImg = document.getElementById('zoomedImage');
    zoomedImg.src = src;
    overlay.style.display = 'flex';
  }

  function closeZoom() { document.getElementById('zoomOverlay').style.display = 'none'; }

  // Indoor navigation functions
  function showBuildingFloors() {
    const building = document.getElementById('buildingSelector').value;
    if (building === '2') {
      document.getElementById('building2Controls').style.display = 'block';
      // Ensure selects are filled from building2Rooms
      populateIndoorRoomSelects();
    } else {
      document.getElementById('building2Controls').style.display = 'none';
      alert('Indoor navigation for Building ' + building + ' coming soon!');
    }
  }

  function openFloor(evt, floorName) {
    const tabcontent = document.getElementsByClassName("tabcontent");
    for (let i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
    const tablinks = document.getElementsByClassName("tablinks");
    for (let i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
    document.getElementById(floorName).style.display = "block";
    evt.currentTarget.className += " active";
  }

  function showRoomInfo(floor) {
    const selectId = floor + 'FloorRooms';
    const infoId = floor + 'FloorInfo';
    const roomNumber = document.getElementById(selectId).value;
    const infoDiv = document.getElementById(infoId);
    if (!roomNumber) { infoDiv.innerHTML = ''; return; }

    if (!building2Rooms || !building2Rooms[floor] || !building2Rooms[floor][roomNumber]) {
      infoDiv.innerHTML = `<p>No data for ${roomNumber}</p>`;
      return;
    }
    const roomData = building2Rooms[floor][roomNumber];
    let infoHTML = `<h4>${roomNumber} - ${roomData.name}</h4>`;
    if (roomData.staff && roomData.staff.length > 0) {
      infoHTML += '<p><strong>Staff:</strong></p><ul>';
      roomData.staff.forEach(staff => { infoHTML += `<li>${staff}</li>`; });
      infoHTML += '</ul>';
    } else {
      infoHTML += '<p>No staff information available</p>';
    }
    infoDiv.innerHTML = infoHTML;
  }

  // Events functions
  function toggleEventsPanel() {
    const eventsPanel = document.getElementById('eventsControls');
    eventsPanelVisible = !eventsPanelVisible;
    eventsPanel.style.display = eventsPanelVisible ? 'block' : 'none';
    if (eventsPanelVisible) loadEvents(); else clearEventMarkers();
  }

  function loadEvents() {
    const eventsList = document.getElementById('eventsList');
    eventsList.innerHTML = '';
    clearEventMarkers();
    events.forEach(event => {
      const eventElement = document.createElement('div');
      eventElement.className = 'event-item';
      eventElement.innerHTML = `<h4>${event.title}</h4><div class="event-meta"><span>${event.date} • ${event.time}</span><br><span class="event-location">${event.location}</span></div><p class="event-description">${event.description}</p>`;
      eventElement.addEventListener('click', () => { zoomToEvent(event); });
      eventsList.appendChild(eventElement);
      addEventMarker(event);
    });
  }

  function addEventMarker(event) {
    const el = document.createElement('div');
    el.className = 'event-marker';
    el.innerHTML = 'E';
    const marker = new mapboxgl.Marker({ element: el }).setLngLat(event.coords)
      .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`
        <div style="width: 200px;">
          <h4 style="color: #f72585; margin-bottom: 5px;">${event.title}</h4>
          <p><strong>When:</strong> ${event.date}, ${event.time}</p>
          <p><strong>Where:</strong> ${event.location}</p>
          <p>${event.description}</p>
        </div>
      `)).addTo(map);
    eventMarkers.push(marker);
  }

  function clearEventMarkers() { eventMarkers.forEach(marker => marker.remove()); eventMarkers = []; }

  function zoomToEvent(event) {
    map.flyTo({ center: event.coords, zoom: 18, essential: true });
    const marker = eventMarkers.find(m => {
      const lngLat = m.getLngLat();
      return lngLat.lng === event.coords[0] && lngLat.lat === event.coords[1];
    });
    if (marker) marker.togglePopup();
  }

  // Theme
  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    if (currentTheme === 'dark') { document.documentElement.removeAttribute('data-theme'); localStorage.setItem('theme','light'); }
    else { document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); }
  }
  function checkTheme() { const savedTheme = localStorage.getItem('theme') || 'light'; if (savedTheme === 'dark') document.documentElement.setAttribute('data-theme','dark'); }

  // Favorites functions
  function toggleFavoritesPanel() {
    const favoritesPanel = document.getElementById('favoritesPanel');
    if (favoritesPanel.style.display === 'block') favoritesPanel.style.display = 'none';
    else { favoritesPanel.style.display = 'block'; renderFavorites(); }
  }
  function renderFavorites() {
    const favoritesList = document.getElementById('favoritesList'); favoritesList.innerHTML = '';
    if (favorites.length === 0) { favoritesList.innerHTML = '<p>No favorite locations saved yet.</p>'; return; }
    favorites.forEach((fav, index) => {
      const favItem = document.createElement('div'); favItem.className = 'favorite-item';
      favItem.innerHTML = `<span>${fav.name}</span><button onclick="removeFavorite(${index}, event)">×</button>`;
      favItem.addEventListener('click', () => { map.flyTo({ center: [fav.coords.lng, fav.coords.lat], zoom: fav.zoom || 16 }); });
      favoritesList.appendChild(favItem);
    });
  }
  function addFavoriteByCoords(coords, name, event) {
    event.stopPropagation();
    const newFavorite = { name: name, coords: { lng: coords[0], lat: coords[1] }, zoom: 16 };
    const isDuplicate = favorites.some(fav => fav.coords.lng === newFavorite.coords.lng && fav.coords.lat === newFavorite.coords.lat);
    if (isDuplicate) { alert('This location is already in your favorites!'); return; }
    favorites.push(newFavorite); saveFavorites(); renderFavorites(); addFavoriteMarker(newFavorite); updatePopupContent(coords, name, true); document.getElementById('favoritesPanel').style.display = 'block';
  }
  function removeFavoriteByCoords(coords, event) {
    event.stopPropagation();
    const index = favorites.findIndex(fav => fav.coords.lng === coords[0] && fav.coords.lat === coords[1]);
    if (index !== -1) {
      if (favoriteMarkers[index]) { favoriteMarkers[index].remove(); favoriteMarkers.splice(index, 1); }
      favorites.splice(index, 1); saveFavorites(); renderFavorites();
      let name = 'Location'; const location = locations.find(loc => loc.coords[0] === coords[0] && loc.coords[1] === coords[1]); if (location) name = location.name;
      updatePopupContent(coords, name, false);
    }
  }
  function removeFavorite(index, event) { event.stopPropagation(); if (favoriteMarkers[index]) { favoriteMarkers[index].remove(); favoriteMarkers.splice(index, 1); } favorites.splice(index, 1); saveFavorites(); renderFavorites(); }
  function updatePopupContent(coords, name, isFavorite) {
    locations.forEach(loc => {
      if (loc.coords[0] === coords[0] && loc.coords[1] === coords[1]) {
        const popupContent = `<div style="width: 200px;"><h4 style="margin-bottom: 8px; color: var(--primary-color);">${name}</h4><img src="${loc.image}" alt="${name}" style="width: 100%; height: auto; cursor: ${loc.zoomable ? 'zoom-in' : 'default'}; border-radius: 4px; margin-bottom: 8px;" ${loc.zoomable ? 'onclick="zoomImage(this.src)"' : ''} /><p style="font-size: 14px; color: #555;">${loc.description}</p>${isFavorite ? `<button class="remove-favorite-btn-popup" onclick="removeFavoriteByCoords([${coords}], event)">Remove from Favorites</button>` : `<button class="add-favorite-btn-popup" onclick="addFavoriteByCoords([${coords}], '${name}', event)">Add to Favorites</button>`}</div>`;
        if (loc.marker && loc.marker.getPopup()) loc.marker.getPopup().setHTML(popupContent);
      }
    });
  }
  function addFavoriteMarker(favorite) {
    const el = document.createElement('div'); el.className = 'favorite-marker'; el.innerHTML = '★';
    const marker = new mapboxgl.Marker({ element: el }).setLngLat([favorite.coords.lng, favorite.coords.lat])
      .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`<div style="width: 200px;"><h4 style="color: var(--accent-color); margin-bottom: 5px;">${favorite.name}</h4><p>Saved location</p><button class="remove-favorite-btn-popup" onclick="removeFavoriteByCoords([${favorite.coords.lng}, ${favorite.coords.lat}], event)">Remove from Favorites</button></div>`))
      .addTo(map);
    favoriteMarkers.push(marker);
  }
  function saveFavorites() { localStorage.setItem('mapFavorites', JSON.stringify(favorites)); }
  function loadFavorites() { favorites = JSON.parse(localStorage.getItem('mapFavorites')) || []; favoriteMarkers.forEach(m => m.remove()); favoriteMarkers = []; favorites.forEach(fav => addFavoriteMarker(fav)); }

  // ---- BACKEND INTEGRATION: fetch building data from API if available; fallback to initial data
  async function loadBuildingData() {
    try {
      const res = await fetch("http://localhost:3000/api/buildings");
      if (!res.ok) throw new Error('No backend');
      const data = await res.json();
      // Expect backend to return object like { building2: { ground: {...}, first: {...}, ... } }
      if (data && data.building2) {
        building2Rooms = data.building2;
      } else {
        // If backend returns the whole file keyed differently, try to use it directly
        building2Rooms = data.building2 || data;
      }
      console.log("Loaded building data from backend:", building2Rooms);
    } catch (err) {
      console.warn("Could not fetch from backend; using fallback in-page data. Error:", err.message);
      building2Rooms = initialBuilding2Rooms;
    }
    // Ensure 4th floor exists
    if (!building2Rooms.fourth) building2Rooms.fourth = {};
    populateIndoorRoomSelects();
  }

  // Populate indoor selects with data from building2Rooms
  function populateIndoorRoomSelects() {
    const floors = ['ground','first','second','third','fourth'];
    floors.forEach(floor => {
      const select = document.getElementById(floor + 'FloorRooms');
      if (!select) return;
      // Clear existing options except default
      while (select.options.length > 1) select.remove(1);
      const floorData = building2Rooms[floor] || {};
      Object.keys(floorData).forEach(roomId => {
        const option = document.createElement('option');
        option.value = roomId;
        option.textContent = `${roomId} - ${floorData[roomId].name || 'Room'}`;
        select.appendChild(option);
      });
    });
  }

  // Settings panel actions: save room settings and add new floor (calls backend endpoints)
  async function saveRoomSettings() {
    const building = document.getElementById("settingsBuilding").value;
    const floor = document.getElementById("settingsFloor").value.trim();
    const roomId = document.getElementById("settingsRoomId").value.trim();
    const name = document.getElementById("settingsRoomName").value.trim();
    const staffRaw = document.getElementById("settingsStaff").value.trim();
    const staff = staffRaw ? staffRaw.split(",").map(s => s.trim()).filter(s => s.length>0) : [];

    if (!floor || !roomId || !name) {
      alert("Please fill Floor, Room ID and Room Name.");
      return;
    }

    // Try backend first
    try {
      const res = await fetch("http://localhost:3000/api/update-room", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ building, floor, roomId, name, staff })
      });
      const result = await res.json();
      if (res.ok) {
        alert("Room saved successfully to backend.");
        await loadBuildingData();
        populateIndoorRoomSelects();
        return;
      } else {
        alert("Backend error: " + (result.error || JSON.stringify(result)));
      }
    } catch (err) {
      console.warn("Backend not available; applying changes locally:", err.message);
      // Apply locally to building2Rooms and refresh the selects
      if (!building2Rooms[floor]) building2Rooms[floor] = {};
      building2Rooms[floor][roomId] = { name, staff };
      populateIndoorRoomSelects();
      alert("Room saved locally (backend not running).");
    }
  }

  async function addNewFloor() {
    const building = document.getElementById("settingsBuilding").value;
    const floorName = document.getElementById("newFloorName").value.trim();
    if (!floorName) { alert("Please enter a floor name."); return; }

    try {
      const res = await fetch("http://localhost:3000/api/add-floor", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ building, floorName })
      });
      const data = await res.json();
      if (res.ok) {
        alert("Floor added successfully on backend.");
        await loadBuildingData();
        populateIndoorRoomSelects();
        return;
      } else {
        alert("Backend error: " + (data.error || JSON.stringify(data)));
      }
    } catch (err) {
      console.warn("Backend not available; adding floor locally:", err.message);
      if (!building2Rooms[floorName]) building2Rooms[floorName] = {};
      populateIndoorRoomSelects();
      alert("Floor added locally (backend not running).");
    }
  }

  function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    panel.style.display = (panel.style.display === "block") ? "none" : "block";
  }

  // Initial load
  window.onload = async function() {
    checkTheme();
    loadFavorites();
    await loadBuildingData();
    populateDropdowns();
  };
</script>

</body>
</html>
